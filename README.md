# Telegram-бот с OpenAI

Telegram-бот на Python (aiogram) с подключением к OpenAI API. У каждого пользователя свой контекст диалога; поддерживается также режим общения через CLI.

## Требования

- Python 3.10+
- Токен бота от [@BotFather](https://t.me/BotFather)
- API-ключ [OpenAI](https://platform.openai.com/api-keys)

## Установка

1. Клонируйте репозиторий и перейдите в папку проекта.

2. Создайте виртуальное окружение и установите зависимости:

   ```bash
   python -m venv venv
   venv\Scripts\activate   # Windows
   # source venv/bin/activate   # Linux/macOS
   pip install -r requirements.txt
   ```

3. Создайте файл `.env` в корне проекта (скопируйте из `.env.example`) и укажите только секреты:

   ```env
   BOT_TOKEN=ваш_токен_от_BotFather
   OPENAI_API_KEY=ваш_ключ_OpenAI
   ```

   Модель, температура и лимит контекста настраиваются в `config.py`.

## Запуск

### Telegram-бот

```bash
python main.py
```

или:

```bash
python bot.py
```

Бот отвечает в Telegram с учётом истории диалога. Чтобы сбросить контекст, напишите: **очистить контекст**.

### CLI (терминал)

```bash
python cli.py
```

Общение с той же моделью и логикой контекста в терминале. Для CLI нужен только `OPENAI_API_KEY` в `.env`.

- **очистить контекст** — сброс истории диалога  
- **exit** / **quit** / **выход** — выход из CLI  

Контекст CLI хранится отдельно от контекста пользователей в Telegram.

## Структура проекта

| Файл | Назначение |
|------|------------|
| `main.py` | Точка входа для запуска бота |
| `bot.py` | Логика Telegram-бота (aiogram), обработчики сообщений |
| `cli.py` | Режим общения в терминале (CLI) |
| `config.py` | Секреты из `.env`, остальные настройки (модель, температура, лимит контекста) |
| `openai_client.py` | Запросы к OpenAI API |
| `context_manager.py` | Хранение контекста диалога в памяти (dict) |
| `.env` | Только секреты — не коммитить (есть в `.gitignore`) |
| `.env.example` | Шаблон для `.env` (только BOT_TOKEN и OPENAI_API_KEY) |
| `.gitignore` | Исключения для git (.env, venv, __pycache__ и др.) |

## Используемые библиотеки

- **aiogram** — работа с Telegram Bot API  
- **openai** — официальный клиент OpenAI  
- **python-dotenv** — загрузка переменных из `.env`  

## Обработка ошибок и логи

- Ошибки OpenAI логируются; пользователю отправляется сообщение с просьбой повторить или очистить контекст.
- Если модель не поддерживает параметр `temperature`, запрос повторяется без него (в логах — предупреждение).
- Уровень логирования для бота — INFO, для CLI — WARNING (чтобы не засорять вывод в терминале).
- После каждого ответа ведётся подсчёт токенов (вход, выход, всего): в боте — в логах, в CLI — выводится под ответом.
